<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">

<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-data-table/iron-data-table.html">
<link rel="import" href="../../bower_components/iron-data-table/data-table-column.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">

<link rel="import" href="ark-m-icons.html">
<link rel="import" href="ark-f-icons.html">

<dom-module id="ark-reader-app">
  <template>
    <style>
      :host {
        display: block;
        height: 100%;
      }

      app-header {
        background-color: #13473f;
        color: #70C0B6;
      }

      * {
        --primary-color: #13473f;
        --primary-text-color: #70C0B6;
      }

      iron-data-table {
        height: calc(100vh - 64px);
      }

      iron-data-table .detail {
        display: flex;
        width: 100%;
        justify-content: space-around;
        align-items: center;
      }
    </style>
    <iron-ajax auto url="/data/classes.json?4" handle-as="json" last-response="{{classes}}"></iron-ajax>
    <iron-ajax auto url="[[_clsUrl(cls)]]" handle-as="json" last-response="{{dinos}}"></iron-ajax>
    <app-drawer-layout>
      <app-drawer swipe-open>
        <div style="height: 100%; overflow: auto;">
          <paper-listbox attr-for-selected="cls" selected="{{cls}}">
            <template is="dom-repeat" items="[[sortedClasses]]">
              <paper-item cls="[[item.cls]]">[[item.name]]</paper-item>
            </template>
          </paper-listbox>
        </div>
      </app-drawer>
      <app-header-layout>
        <app-header fixed>
          <app-toolbar>
            <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
            <div title>Q's Ark Reader</div>
          </app-toolbar>
        </app-header>
        <iron-data-table items="[[dinoData]]" before-cell-bind="[[_boundBeforeCellBind]]">
          <template is="row-detail">
            <div class="detail">

            </div>
          </template>
          <data-table-column width="0">
            <template><iron-icon icon="[[_genderIcon(item)]]"></iron-icon></template>
          </data-table-column>
          <data-table-column name="Level" sort-by="baseLevel">
            <template>[[item.baseLevel]]</template>
          </data-table-column>
          <data-table-column name="Name" sort-by="name">
            <template>[[item.name]]</template>
          </data-table-column>
          <data-table-column name="Lat" width="70">
            <template>[[item.lat]]</template>
          </data-table-column>
          <data-table-column name="Lon" width="70">
            <template>[[item.lon]]</template>
          </data-table-column>
          <data-table-column name="Leben" breeding sort-by="wildLevels.health">
            <template>[[item.wildLevels.health]]</template>
          </data-table-column>
          <data-table-column name="Ausdauer" breeding sort-by="wildLevels.stamina">
            <template>[[item.wildLevels.stamina]]</template>
          </data-table-column>
          <data-table-column name="Sauerstoff" breeding sort-by="wildLevels.oxygen">
            <template>[[item.wildLevels.oxygen]]</template>
          </data-table-column>
          <data-table-column name="Nahrung" breeding sort-by="wildLevels.food">
            <template>[[item.wildLevels.food]]</template>
          </data-table-column>
          <data-table-column name="Gewicht" breeding sort-by="wildLevels.weight">
            <template>[[item.wildLevels.weight]]</template>
          </data-table-column>
          <data-table-column name="Nahkampf" breeding sort-by="wildLevels.melee">
            <template>[[item.wildLevels.melee]]</template>
          </data-table-column>
        </iron-data-table>
      </app-header-layout>
    </app-drawer-layout>
  </template>

  <script>
    Polymer({

      is: 'ark-reader-app',

      properties: {
        dinoData: {
          type: Array,
          computed: '_filterAndFix(dinos)'
        },
        sortedClasses: {
          type: Array,
          computed: '_sortClasses(classes)'
        },
        _boundBeforeCellBind: {
          type: Object,
          value: function() {
            return this._beforeCellBind.bind(this)
          }
        }
      },

      _clsUrl: function(cls) {
        return '/data/' + cls + '_Character_BP_C.json'
      },

      _sortClasses: function(data) {
        var myData = data.slice()

        myData.sort(function(a,b){
          return a.name > b.name ? 1 : a.name == b.name ? 0 : -1
        })

        return myData
      },

      _filterAndFix: function(data) {
        var mydata = data.slice(1)

        mydata.sort(function(a,b){
          return a.baseLevel > b.baseLevel ? -1 : a.baseLevel == b.baseLevel ? 0 : 1
        })

        mydata.forEach(function(a){
          ["health","stamina","oxygen","food","weight","melee"].forEach(function(f){
            if (typeof a.wildLevels[f] === 'undefined') {
              a.wildLevels[f] = 0
            }
          })

          a.name = a.name ? a.name : a.tamed ? '-' : ''
        })

        return mydata
      },

      _null: function(x) {
        return x ? x : 0
      },

      _tamed: function(x) {
        return x.tamed ? 'Name ' + x.name : ''
      },

      _genderIcon: function(x) {
        return x.female ? 'ark-f:female' : 'ark-m:male'
      },

      _beforeCellBind: function(data, cell) {
        var maxHueValue = 150 / 6 * 1.4 // 40% > mean
        if (data.item && data.item.wildLevels && cell.column.hasAttribute('breeding')) {
          var v = Polymer.Base.get(cell.column.sortBy, data.item)
          var hue = Math.min(120, Math.round(120 * v / maxHueValue))
          cell.style.backgroundColor = 'hsl(' + hue + ', 100%, 85%)'
        }
      },

    })
  </script>
</dom-module>
